---
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { prisma } from "../../lib/prisma";
import { formatAuthors, slugifyTitle } from "../../lib/book-utils";
import {
  SOURCE_TYPE_LABELS,
  FUNCTION_LABELS,
  DIFFICULTY_LABELS,
  TRADITION_LABELS,
} from "../../lib/book-facets";

const { slug } = Astro.params;

if (!slug) {
  return new Response("Not found", { status: 404 });
}

// Convert slug back to tag name (e.g., "marxist-theory" -> "Marxist Theory")
const tagName = slug
  .split("-")
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(" ");

// Find all videos with this tag
const videos = await prisma.video.findMany({
  where: {
    isPublished: true,
    tags: {
      hasSome: [tagName],
    },
  },
  orderBy: [{ order: "asc" }, { createdAt: "desc" }],
  include: {
    channel: true,
  },
});

// Convert slug to possible facet enum values
const slugifiedLabels = {
  sourceTypes: Object.entries(SOURCE_TYPE_LABELS)
    .filter(([_, label]) => slugifyTitle(label) === slug)
    .map(([value]) => value),
  functions: Object.entries(FUNCTION_LABELS)
    .filter(([_, label]) => slugifyTitle(label) === slug)
    .map(([value]) => value),
  difficulties: Object.entries(DIFFICULTY_LABELS)
    .filter(([_, label]) => slugifyTitle(label) === slug)
    .map(([value]) => value),
  traditions: Object.entries(TRADITION_LABELS)
    .filter(([_, label]) => slugifyTitle(label) === slug)
    .map(([value]) => value),
};

// Build OR clauses for book query (tags, categories, AND facets)
const bookOrClauses: any[] = [
  { tags: { hasSome: [tagName] } },
  { categories: { hasSome: [tagName] } },
];

// Add facet matches
if (slugifiedLabels.sourceTypes.length > 0) {
  bookOrClauses.push({ sourceType: { in: slugifiedLabels.sourceTypes } });
}
if (slugifiedLabels.functions.length > 0) {
  bookOrClauses.push({ functions: { hasSome: slugifiedLabels.functions } });
}
if (slugifiedLabels.difficulties.length > 0) {
  bookOrClauses.push({ difficulty: { in: slugifiedLabels.difficulties } });
}
if (slugifiedLabels.traditions.length > 0) {
  bookOrClauses.push({ traditions: { hasSome: slugifiedLabels.traditions } });
}

// Find all books with this tag/category/facet
const books = await prisma.book.findMany({
  where: {
    isPublished: true,
    OR: bookOrClauses,
  },
  orderBy: [{ order: "asc" }, { createdAt: "desc" }],
});

if (videos.length === 0 && books.length === 0) {
  return new Response("Not found", { status: 404 });
}
---

<Layout title={`${tagName} - MLCompanion`}>
  <div class="page">
    <Breadcrumb items={[
      { label: "Home", href: "/" },
      { label: tagName }
    ]} />

    <header class="hero">
      <p class="eyebrow">Topic</p>
      <h1>{tagName}</h1>
      <p class="subhead">
        {videos.length > 0 && `${videos.length} video${videos.length !== 1 ? "s" : ""}`}
        {videos.length > 0 && books.length > 0 && " â€¢ "}
        {books.length > 0 && `${books.length} book${books.length !== 1 ? "s" : ""}`}
      </p>
    </header>

    {videos.length > 0 && (
      <section class="panel" style="margin-top: 1.5rem;">
        <h2>Videos</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
          {videos.map((video) => (
            <a
              href={`/video/${video.id}`}
              style="text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 0.75rem;"
            >
              <div style="position: relative; width: 100%; padding-bottom: 56.25%; background: var(--border-color); border-radius: 8px; overflow: hidden;">
                {video.thumbnailUrl && (
                  <img
                    src={video.thumbnailUrl}
                    alt={video.title}
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                  />
                )}
                {video.duration && (
                  <span style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.85); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                    {video.duration}
                  </span>
                )}
              </div>
              <div>
                <h3 style="font-size: 1rem; font-weight: 600; margin: 0; line-height: 1.4;">
                  {video.title}
                </h3>
                {video.channel && (
                  <p class="muted" style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                    {video.channel.name}
                  </p>
                )}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {books.length > 0 && (
      <section class="panel" style="margin-top: 1.5rem;">
        <h2>Books</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
          {books.map((book) => {
            const bookSlug = `${slugifyTitle(book.title)}-${book.id}`;
            return (
              <a
                href={`/book/${bookSlug}`}
                style="text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 0.5rem;"
              >
                <div style="position: relative; width: 100%; padding-bottom: 150%; background: var(--border-color); border-radius: 8px; overflow: hidden;">
                  {book.thumbnailUrl ? (
                    <img
                      src={book.thumbnailUrl}
                      alt={book.title}
                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                    />
                  ) : (
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 1rem; text-align: center;">
                      <span style="color: white; font-weight: 700; font-size: 0.875rem; line-height: 1.3;">
                        {book.title}
                      </span>
                    </div>
                  )}
                </div>
                <div>
                  <h3 style="font-size: 0.9rem; font-weight: 600; margin: 0; line-height: 1.4;">
                    {book.title}
                  </h3>
                  {book.authors.length > 0 && (
                    <p class="muted" style="margin: 0.25rem 0 0 0; font-size: 0.8rem;">
                      {formatAuthors(book.authors)}
                    </p>
                  )}
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </div>
</Layout>
