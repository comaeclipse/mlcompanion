---
import Layout from "../../../layouts/Layout.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import { BookLibraryWithToggle } from "../../../components/BookLibraryWithToggle";
import { prisma } from "../../../lib/prisma";
import { getProxiedImageUrl } from "../../../lib/image-utils";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/books");
}

const author = await prisma.author.findUnique({
  where: { slug },
  include: {
    books: {
      where: { book: { isPublished: true } },
      include: { book: true },
      orderBy: { order: "asc" }
    }
  }
});

if (!author) {
  return Astro.redirect("/books");
}

const books = author.books.map(ba => ba.book).filter(Boolean);
// Use direct blob URL without Vercel image optimization
const photoUrl = author.photoUrl && (
  author.photoUrl.includes('blob.vercel-storage.com') || 
  author.photoUrl.startsWith('blob:') ||
  author.photoUrl.startsWith('data:')
) 
  ? author.photoUrl 
  : getProxiedImageUrl(author.photoUrl, { width: 400, quality: 80 });
---

<Layout title={`${author.name} - Books - MLCompanion`}>
  <div class="page">
    <Breadcrumb items={[
      { label: "Home", href: "/" },
      { label: "Books", href: "/books" },
      { label: author.name }
    ]} />

    {/* Two-column layout */}
    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 2rem;">

      {/* Left Column: Photo */}
      <div>
        {photoUrl ? (
          <img
            src={photoUrl}
            alt={author.name}
            style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 2px solid var(--border-color);"
          />
        ) : (
          <div
            style="width: 100%; aspect-ratio: 1; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 6rem; font-weight: 600; border: 2px solid var(--border-color);"
          >
            {author.name.charAt(0).toUpperCase()}
          </div>
        )}
      </div>

      {/* Right Column: Name, Bio, Books */}
      <div>
        <div style="margin-bottom: 1.5rem;">
          <p class="eyebrow">Author</p>
          <h1 style="margin-bottom: 0.5rem;">{author.name}</h1>
          <p class="muted" style="margin: 0;">
            {books.length} {books.length === 1 ? "book" : "books"} available
          </p>
        </div>

        {author.bio && (
          <div style="margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Biography</h2>
            <p style="line-height: 1.6; color: var(--text-color); white-space: pre-wrap;">
              {author.bio}
            </p>
          </div>
        )}

        <div style="margin-bottom: 1rem;">
          <h2 style="font-size: 1.2rem; margin-bottom: 0.75rem;">Books</h2>
        </div>
      </div>
    </div>

    {/* Books Section */}
    <section>
      {books.length > 0 ? (
        <BookLibraryWithToggle client:load books={books} />
      ) : (
        <div class="panel" style="text-align: center; padding: 3rem;">
          <p class="muted">No books available by this author yet.</p>
        </div>
      )}
    </section>

    <div style="margin-top: 2rem; text-align: center;">
      <a href="/books" style="text-decoration: none; color: var(--accent-color); font-size: 0.9rem;">
        &larr; Back to all books
      </a>
    </div>
  </div>
</Layout>
