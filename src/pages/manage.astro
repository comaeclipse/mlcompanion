---
import Layout from "../layouts/Layout.astro";
import Breadcrumb from "../components/Breadcrumb.astro";
import { getSessionFromRequest } from "../lib/auth";
import { prisma } from "../lib/prisma";
import { ManagePortal } from "../components/ManagePortal";

const result = await getSessionFromRequest(Astro.request);
if (!result?.user) {
  return Astro.redirect("/login");
}
const session = result;

const url = new URL(Astro.request.url);
const tabParam = url.searchParams.get("tab");
const activeTab = tabParam === "books" ? "books" : tabParam === "authors" ? "authors" : tabParam === "channels" ? "channels" : tabParam === "podcasts" ? "podcasts" : "videos";

let books = null;
let videos = null;
let authors = null;
let channels = null;
let podcasts = null;

if (activeTab === "books") {
  books = await prisma.book.findMany({
    where: {
      createdBy: session.user.id,
      isPublished: true,
    },
    orderBy: [{ order: "asc" }, { createdAt: "desc" }],
  });
} else if (activeTab === "videos") {
  videos = await prisma.video.findMany({
    where: {
      createdBy: session.user.id,
      isPublished: true,
    },
    orderBy: [{ order: "asc" }, { createdAt: "desc" }],
  });
} else if (activeTab === "channels") {
  channels = await prisma.channel.findMany({
    where: {
      createdBy: session.user.id,
    },
    orderBy: { name: "asc" },
    include: {
      _count: { select: { videos: true } }
    }
  });
} else if (activeTab === "podcasts") {
  podcasts = await prisma.podcast.findMany({
    where: {
      createdBy: session.user.id,
      isPublished: true,
    },
    orderBy: [{ order: "asc" }, { createdAt: "desc" }],
    include: {
      _count: { select: { episodes: true } },
      episodes: {
        where: { isPublished: true },
        orderBy: [{ order: "asc" }, { publishedAt: "desc" }, { createdAt: "desc" }],
      },
    },
  });
} else {
  // Authors tab - show all authors (global editing model)
  authors = await prisma.author.findMany({
    orderBy: { name: "asc" },
    include: {
      _count: { select: { books: true } }
    }
  });
}
---

<Layout title="Manage - MLCompanion">
  <div class="page">
    <Breadcrumb items={[
      { label: "Home", href: "/" },
      { label: "Manage" }
    ]} />
  </div>
  <ManagePortal client:load initialTab={activeTab} initialBooks={books} initialVideos={videos} initialAuthors={authors} initialChannels={channels} initialPodcasts={podcasts} />
</Layout>
