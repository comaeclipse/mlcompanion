---
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { prisma } from "../../lib/prisma";
import { formatAuthors, slugifyTitle } from "../../lib/book-utils";
import { getProxiedImageUrl } from "../../lib/image-utils";
import {
  SOURCE_TYPE_LABELS,
  FUNCTION_LABELS,
  DIFFICULTY_LABELS,
  TRADITION_LABELS,
  getFacetColor,
} from "../../lib/book-facets";
import { parseEpisodeUrl } from "../../lib/episode-utils";

const { slug } = Astro.params;

const slugValue = slug ?? "";
const idMatch = slugValue.match(/-([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$/i);

const bookById = idMatch
  ? await prisma.book.findUnique({
      where: { id: idMatch[1] },
      include: {
        linkedEpisodes: {
          include: {
            episode: {
              select: {
                id: true,
                title: true,
                description: true,
                externalUrl: true,
                thumbnailUrl: true,
                duration: true,
                publishedAt: true,
                podcast: {
                  select: {
                    name: true,
                    slug: true,
                    thumbnailUrl: true,
                  },
                },
              },
            },
          },
        },
      },
    })
  : null;

const bookFromSlug = await prisma.book.findMany({
  where: { isPublished: true },
  orderBy: [{ order: "asc" }, { createdAt: "desc" }],
  include: {
    linkedEpisodes: {
      include: {
        episode: {
          select: {
            id: true,
            title: true,
            description: true,
            externalUrl: true,
            thumbnailUrl: true,
            duration: true,
            publishedAt: true,
            podcast: {
              select: {
                name: true,
                slug: true,
                thumbnailUrl: true,
              },
            },
          },
        },
      },
    },
  },
});

const book = bookById || bookFromSlug.find((item) => slugifyTitle(item.title) === slugValue) || null;

if (!book) {
  return new Response("Not found", { status: 404 });
}

// Use direct URL for all images (Vercel proxy has issues with external URLs)
const coverUrl = book.thumbnailUrl;
const authorLabel = formatAuthors(book.authors);

const formatCount = (value?: number | null) => {
  if (value === null || value === undefined) return "";
  return value.toLocaleString();
};

const getDomain = (url: string) => {
  try {
    return new URL(url).hostname.replace("www.", "");
  } catch {
    return url;
  }
};

// Type definition for purchase links JSON structure
interface PurchaseLinks {
  amazon?: string;
  custom?: Array<{ label?: string; url?: string }>;
}

// Type definition for external reviews JSON structure
interface ExternalReview {
  authorUsername?: string;
  reviewDate?: string;
  score?: number;
  sourceUrl?: string;
  contentHtml?: string;
}

const purchaseLinks = book.purchaseLinks as PurchaseLinks | null;
const externalReviews = Array.isArray(book.externalReviews) 
  ? (book.externalReviews as ExternalReview[]) 
  : [];

const stripInlineStyles = (html: string) => {
  // Remove inline style attributes and strip out excessive formatting
  return html
    .replace(/\s*style="[^"]*"/gi, '')
    .replace(/\s*class="[^"]*"/gi, '')
    .replace(/<span[^>]*>/gi, '')
    .replace(/<\/span>/gi, '');
};
---

<Layout title={`${book.title} - MLCompanion`}>
  <div class="page">
    <Breadcrumb items={[
      { label: "Home", href: "/" },
      { label: "Books", href: "/books" },
      { label: book.title }
    ]} />

    <header class="hero">
      <div style="display: flex; gap: 2rem; flex-wrap: wrap; align-items: flex-start;">
        <div style="flex-shrink: 0;">
          {coverUrl ? (
            <img
              src={coverUrl}
              alt={book.title}
              style="width: 220px; height: 330px; object-fit: cover; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);"
            />
          ) : (
            <div style="width: 220px; height: 330px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; padding: 1rem; text-align: center;">
              {book.title}
            </div>
          )}

          {/* Availability Section */}
          {(book.readFreeLinks?.length > 0 || purchaseLinks) && (
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); width: 220px;">
              {/* Read Free Links */}
              {book.readFreeLinks && book.readFreeLinks.length > 0 && (
                <p style="font-size: 0.95rem; margin: 0 0 0.75rem 0; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                  <span style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--ink-color);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                      <path d="M12 7v14"></path>
                    </svg>
                    <span>Read at</span>
                  </span>
                  {book.readFreeLinks.map((link, index) => (
                    <span>
                      {index > 0 && <span style="color: var(--muted-color);">, </span>}
                      <a href={link} target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.15s;">
                        {getDomain(link)}
                      </a>
                    </span>
                  ))}
                </p>
              )}

              {/* Purchase Links */}
              {purchaseLinks && (() => {
                const links = [];

                if (purchaseLinks.amazon) {
                  links.push({
                    url: purchaseLinks.amazon,
                    domain: getDomain(purchaseLinks.amazon),
                  });
                }

                purchaseLinks.custom?.forEach((custom) => {
                  if (custom.url) {
                    links.push({
                      url: custom.url,
                      domain: custom.label || getDomain(custom.url),
                    });
                  }
                });

                return links.length > 0 ? (
                  <p style="font-size: 0.95rem; margin: 0; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--ink-color);">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2980b9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="8" cy="21" r="1"></circle>
                        <circle cx="19" cy="21" r="1"></circle>
                        <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                      </svg>
                      <span>Purchase at</span>
                    </span>
                    {links.map((link, index) => (
                      <span>
                        {index > 0 && <span style="color: var(--muted-color);">, </span>}
                        <a href={link.url} target="_blank" rel="noopener noreferrer" style="color: var(--accent-color); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.15s;">
                          {link.domain}
                        </a>
                      </span>
                    ))}
                  </p>
                ) : null;
              })()}
            </div>
          )}
        </div>

        <div style="flex: 1; min-width: 240px;">
          <p class="eyebrow">Book</p>
          <h1>{book.title}</h1>
          <p class="subhead">{authorLabel}</p>
          <div class="hero-meta">
            {book.publisher && <span>{book.publisher}</span>}
            {book.publishedDate && <span>{book.publishedDate}</span>}
            {book.pageCount && <span>{book.pageCount} pages</span>}
          </div>

          {(book.isbn || book.isbn13) && (
            <p class="muted" style="margin-top: 0.75rem;">
              {book.isbn13 && `ISBN-13: ${book.isbn13}`}
              {book.isbn13 && book.isbn && " • "}
              {book.isbn && `ISBN-10: ${book.isbn}`}
            </p>
          )}

          {(book.goodreadsRating !== null && book.goodreadsRating !== undefined) ||
          (book.goodreadsReviews !== null && book.goodreadsReviews !== undefined) ? (
            <p class="muted" style="margin-top: 0.5rem;">
              Goodreads: {book.goodreadsRating ?? "N/A"}
              {book.goodreadsReviews !== null && book.goodreadsReviews !== undefined
                ? ` / ${formatCount(book.goodreadsReviews)} reviews`
                : ""}
            </p>
          ) : null}

          {(book.tags.length > 0 || book.categories.length > 0) && (
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
              {book.tags.map((tag) => (
                <a
                  href={`/topic/${tag.toLowerCase().replace(/\s+/g, "-")}`}
                  class="badge"
                >
                  {tag}
                </a>
              ))}
              {book.categories.map((category) => (
                <a
                  href={`/topic/${category.toLowerCase().replace(/\s+/g, "-")}`}
                  class="badge"
                  style="color: #667eea; border-color: rgba(102, 126, 234, 0.4);"
                >
                  {category}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>
    </header>

    <section class="panel" style="margin-top: 1.5rem;">
      <h2>Description</h2>
      <p style="white-space: pre-line; color: var(--muted-color); line-height: 1.7;">{book.description}</p>
    </section>

    {/* Classification Panel */}
    {(book.sourceType || book.difficulty || book.functions?.length > 0 || book.traditions?.length > 0) && (
      <section class="panel" style="margin-top: 1.5rem;">
        <h2>Classification</h2>
        <dl style="display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem; align-items: start;">
          {book.sourceType && (
            <>
              <dt style="font-weight: 600; color: var(--ink-color);">Type:</dt>
              <dd style="margin: 0;">
                <span
                  class="badge"
                  style={`background: ${getFacetColor("sourceType", book.sourceType).bg}; color: ${getFacetColor("sourceType", book.sourceType).text}; border-color: ${getFacetColor("sourceType", book.sourceType).text}33;`}
                >
                  {SOURCE_TYPE_LABELS[book.sourceType]}
                </span>
              </dd>
            </>
          )}

          {book.difficulty && (
            <>
              <dt style="font-weight: 600; color: var(--ink-color);">Difficulty:</dt>
              <dd style="margin: 0;">
                <span
                  class="badge"
                  style={`background: ${getFacetColor("difficulty", book.difficulty).bg}; color: ${getFacetColor("difficulty", book.difficulty).text}; border-color: ${getFacetColor("difficulty", book.difficulty).text}33;`}
                >
                  {DIFFICULTY_LABELS[book.difficulty]}
                </span>
              </dd>
            </>
          )}

          {book.functions && book.functions.length > 0 && (
            <>
              <dt style="font-weight: 600; color: var(--ink-color);">Function:</dt>
              <dd style="margin: 0; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {book.functions.map((func) => (
                  <span
                    key={func}
                    class="badge"
                    style={`background: ${getFacetColor("function", func).bg}; color: ${getFacetColor("function", func).text}; border-color: ${getFacetColor("function", func).text}33;`}
                  >
                    {FUNCTION_LABELS[func]}
                  </span>
                ))}
              </dd>
            </>
          )}

          {book.traditions && book.traditions.length > 0 && (
            <>
              <dt style="font-weight: 600; color: var(--ink-color);">Tradition:</dt>
              <dd style="margin: 0; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {book.traditions.map((trad) => (
                  <span
                    key={trad}
                    class="badge"
                    style={`background: ${getFacetColor("tradition", trad).bg}; color: ${getFacetColor("tradition", trad).text}; border-color: ${getFacetColor("tradition", trad).text}33;`}
                  >
                    {TRADITION_LABELS[trad]}
                  </span>
                ))}
              </dd>
            </>
          )}
        </dl>
      </section>
    )}

    {externalReviews.length > 0 && (
      <section class="panel" style="margin-top: 1.5rem;">
        <h2>External Reviews</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          {externalReviews.map((review) => (
            <div style="background: #fbf7f1; border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem;">
              <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: baseline;">
                <strong>{review.authorUsername || "Anonymous"}</strong>
                {review.reviewDate && (
                  <span class="muted" style="font-size: 0.85rem;">{review.reviewDate}</span>
                )}
                {review.score !== undefined && review.score !== null && (
                  <span class="muted" style="font-size: 0.85rem;">Score: {review.score}</span>
                )}
                {review.sourceUrl && (
                  <a
                    href={review.sourceUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    style="font-size: 0.85rem; color: var(--accent-color); text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;"
                  >
                    {getDomain(review.sourceUrl)}
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-top: 1px;">
                      <path d="M7 7h10v10"></path>
                      <path d="M7 17 17 7"></path>
                    </svg>
                  </a>
                )}
              </div>
              {review.contentHtml && (
                <div
                  style="margin-top: 0.75rem; color: var(--muted-color); line-height: 1.7;"
                  set:html={stripInlineStyles(review.contentHtml)}
                />
              )}
            </div>
          ))}
        </div>
      </section>
    )}

    {book.linkedEpisodes && book.linkedEpisodes.length > 0 && (
      <section class="panel" style="margin-top: 1.5rem;">
        <h2>Companion Media</h2>
        <p class="muted" style="margin: 0.5rem 0 1rem; font-size: 0.9rem;">
          Podcast episodes that reference or discuss this book:
        </p>
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          {book.linkedEpisodes.map((le) => {
            const episode = le.episode;
            const embedInfo = episode.externalUrl ? parseEpisodeUrl(episode.externalUrl) : null;
            
            return (
              <div style="background: #fbf7f1; border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem;">
                <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                  {episode.podcast.thumbnailUrl && (
                    <img 
                      src={episode.podcast.thumbnailUrl} 
                      alt={episode.podcast.name}
                      style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; flex-shrink: 0;"
                    />
                  )}
                  <div style="flex: 1; min-width: 0;">
                    <h3 style="margin: 0 0 0.25rem; font-size: 1.05rem; font-weight: 600;">
                      <a 
                        href={`/episode/${episode.id}`}
                        style="color: var(--ink-color); text-decoration: none;"
                      >
                        {episode.title}
                      </a>
                    </h3>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--muted-color);">
                      <a 
                        href={`/podcasts/show/${episode.podcast.slug}`}
                        style="color: var(--accent-color); text-decoration: none;"
                      >
                        {episode.podcast.name}
                      </a>
                      {episode.duration && <span> • {episode.duration}</span>}
                      {episode.publishedAt && (
                        <span> • {new Date(episode.publishedAt).toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "short",
                          day: "numeric",
                        })}</span>
                      )}
                    </p>
                  </div>
                </div>

                {episode.description && (
                  <p style="margin: 0 0 1rem; color: var(--muted-color); font-size: 0.9rem; line-height: 1.6;">
                    {episode.description.length > 200 
                      ? episode.description.substring(0, 200) + "..." 
                      : episode.description}
                  </p>
                )}

                {embedInfo && (
                  <div style="margin-top: 1rem;">
                    {embedInfo.type === "spotify" && (
                      <iframe
                        src={embedInfo.embedUrl}
                        width="100%"
                        height="232"
                        frameborder="0"
                        allowfullscreen=""
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                        loading="lazy"
                        style="border-radius: 12px;"
                      ></iframe>
                    )}
                    {embedInfo.type === "apple" && (
                      <iframe
                        src={embedInfo.embedUrl}
                        width="100%"
                        height="175"
                        frameborder="0"
                        sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation"
                        allow="autoplay *; encrypted-media *; clipboard-write"
                        style="border-radius: 12px; border: none; overflow: hidden; background: transparent;"
                      ></iframe>
                    )}
                  </div>
                )}

                {episode.externalUrl && (
                  <div style="margin-top: 1rem;">
                    <a
                      href={episode.externalUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="button"
                      style="display: inline-block; font-size: 0.85rem; padding: 0.5rem 1rem;"
                    >
                      Listen on {embedInfo?.type === "spotify" ? "Spotify" : embedInfo?.type === "apple" ? "Apple Podcasts" : "Platform"}
                    </a>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </section>
    )}
  </div>
</Layout>
