---
import Layout from "../../../layouts/Layout.astro";
import Breadcrumb from "../../../components/Breadcrumb.astro";
import { VideoLibraryWithToggle } from "../../../components/VideoLibraryWithToggle";
import { prisma } from "../../../lib/prisma";

const { slug } = Astro.params;

// Try to find channel by slug
const channel = await prisma.channel.findUnique({
  where: { slug },
  include: {
    _count: { select: { videos: true } },
  },
});

// Find videos by channel reference or legacy channelName
const videos = channel
  ? await prisma.video.findMany({
      where: {
        isPublished: true,
        channelId: channel.id,
      },
      orderBy: [{ publishedAt: "desc" }, { createdAt: "desc" }],
    })
  : await prisma.video.findMany({
      where: {
        isPublished: true,
        channelName: {
          mode: "insensitive",
          equals: slug?.replace(/-/g, " ") || "",
        },
      },
      orderBy: [{ publishedAt: "desc" }, { createdAt: "desc" }],
    });

// Get other channels if no videos found
const allChannels = videos.length === 0
  ? await prisma.channel.findMany({
      select: {
        name: true,
        slug: true,
      },
      take: 10,
    })
  : [];

const channelName = channel?.name || videos[0]?.channelName || slug?.replace(/-/g, " ") || "";
const videoCount = videos.length;
---

<Layout title={`${channelName} - MLCompanion`}>
  <div class="page">
    <Breadcrumb
      items={[
        { label: "Home", href: "/" },
        { label: "Videos", href: "/videos" },
        { label: channelName },
      ]}
    />

    <header class="hero">
      <div
        style="display: flex; align-items: start; gap: 2rem; flex-wrap: wrap;"
      >
        {/* Channel Avatar */}
        {channel?.thumbnailUrl ? (
          <img
            src={channel.thumbnailUrl}
            alt={channelName}
            style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); flex-shrink: 0;"
          />
        ) : (
          <div
            style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-color), #d4835f); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; font-weight: 700; flex-shrink: 0;"
          >
            {channelName.charAt(0).toUpperCase()}
          </div>
        )}

        {/* Channel Info */}
        <div style="flex: 1; min-width: 250px;">
          <h1 style="margin-bottom: 0.5rem;">{channelName}</h1>
          
          <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
            {channel?.subscriberCount && (
              <p class="muted" style="margin: 0; font-weight: 500;">
                üìä {channel.subscriberCount.toLocaleString()} subscribers
              </p>
            )}
            <p class="muted" style="margin: 0;">
              üé• {videoCount} {videoCount === 1 ? "video" : "videos"}
            </p>
            {channel?.viewCount && (
              <p class="muted" style="margin: 0;">
                üëÅÔ∏è {channel.viewCount.toLocaleString()} views
              </p>
            )}
          </div>

          {channel?.description && (
            <p class="muted" style="margin: 0 0 1rem 0; line-height: 1.5;">
              {channel.description.length > 200 ? channel.description.slice(0, 197) + "..." : channel.description}
            </p>
          )}

          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            {channel?.url ? (
              <a
                href={channel.url}
                target="_blank"
                rel="noopener noreferrer"
                class="button"
                style="text-decoration: none;"
              >
                üîó View on YouTube
              </a>
            ) : (
              <a
                href={`https://www.youtube.com/results?search_query=${encodeURIComponent(channelName)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="button"
                style="text-decoration: none;"
              >
                üîç Find on YouTube
              </a>
            )}
          </div>
        </div>
      </div>
    </header>

    <section style="margin-top: 2rem;">
      {videos.length === 0 ? (
        <div class="panel" style="text-align: center; padding: 3rem;">
          <h2 style="margin-top: 0;">No videos found</h2>
          <p class="muted">
            No videos from this channel are available yet.
          </p>
          {allChannels.length > 0 && (
            <div style="margin-top: 2rem;">
              <p class="muted" style="margin-bottom: 1rem;">
                Browse other channels:
              </p>
              <div
                style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;"
              >
                {allChannels.slice(0, 10).map((ch) => (
                  <a
                    href={`/videos/channel/${ch.slug}`}
                    class="pill"
                    style="text-decoration: none;"
                  >
                    {ch.name}
                  </a>
                ))}
              </div>
            </div>
          )}
          <div style="margin-top: 1.5rem;">
            <a href="/videos" class="button" style="text-decoration: none;">
              ‚Üê Back to all videos
            </a>
          </div>
        </div>
      ) : (
        <>
          <div
            style="border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; padding-bottom: 0.5rem;"
          >
            <h2 style="margin: 0; font-size: 1.2rem;">üìπ Videos</h2>
          </div>
          <VideoLibraryWithToggle client:load videos={videos} />
        </>
      )}
    </section>
  </div>
</Layout>

<style>
  .button:hover {
    opacity: 0.9;
  }
</style>
